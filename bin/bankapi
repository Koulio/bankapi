#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import json
import psycopg2
import psycopg2.extras
import re
import httplib
import pprint
import socket
import getopt

pg_connect_str = "dbname=bankapi"
pg_conn = None

def bail(error=None):

    if error is not None:
        print "Error: %s" % (error.rstrip())
    else:
        print "Usage: %s [-d dbname] FROMBANK TOBANK filename [ filename ... ]" % (sys.argv[0])
        print ""
        print "To read a message from stdin, you can use - as the filename"
        print ""
        print "    -d dbname     Name of database to use locally (default: bankapi)"

    sys.exit(1)

try:
    opts, args = getopt.getopt(sys.argv[1:], 'd:')
    for o, a in opts:
        if o == '-d':
            pg_connect_str = "dbname=%s" % (a)
        else:
            bail()
except getopt.GetoptError as e:
    bail()
    
if len(args) < 3:
    bail()

from_bank = args[0]
to_bank = args[1]
msg_filenames = args[2:]

try:
    pg_conn = psycopg2.connect(pg_connect_str)
except psycopg2.OperationalError as e:
    bail(error='Failed to connect to database: %s' % (e))

for filename in msg_filenames:
    fh = None
    if filename == '-':
        fh = sys.stdin
        filename = '<stdin>'
    else:
        try:
            fh = open(filename, 'r')
        except IOError as e:
            bail(error='Could not open file %s: %s' % (filename, e))

    messagetext = None
    try:
        messagetext = fh.read()
    except IOError as e:
        bail(error='Failed to read from file %s: %s' % (filename, e))

    if messagetext is None or len(messagetext) == 0:
        bail(error='No message text in file %s' % (filename))

    cur = pg_conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
    messagehub_host, messagehub_port, messagehub_proto, messagehub_path = None, None, None, None
    try:
        cur.execute("SELECT Protocol, Host, Port, Path FROM Banks WHERE BankID = %s", 
            [to_bank]);

        sqldata = cur.fetchone()
        messagehub_proto = sqldata['protocol']
        messagehub_host = sqldata['host']
        messagehub_port = sqldata['port']
        messagehub_path = sqldata['path']
        pg_conn.commit()
    except (psycopg2.InternalError, psycopg2.ProgrammingError) as e:
        pg_conn.rollback()
        bail(error=e.pgerror)


    client = None
    messagehub_str = None
    messagehub_expected_port = 443
    if messagehub_proto == 'https':
        client = httplib.HTTPSConnection(messagehub_host, messagehub_port)
    else:
        client = httplib.HTTPConnection(messagehub_host, messagehub_port)
        messagehub_expected_port = 80

    if messagehub_port != messagehub_expected_port:
        messagehub_str = "%s://%s:%s%s" % (messagehub_proto, messagehub_host, messagehub_port, messagehub_path)
    else:
        messagehub_str = "%s://%s%s" % (messagehub_proto, messagehub_host, messagehub_path)

    print "Sending message %s -> %s using %s ... " % (from_bank, to_bank, messagehub_str),
    cur = pg_conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
    messageid = None

    ciphertext = None
    try:
        cur.execute("""SELECT CipherText FROM Get_Message(Create_Message(
            _PlainText := %s,
            _FromBankID := %s,
            _ToBankID := %s
            ))""",
            [messagetext, from_bank, to_bank]);

        sqldata = cur.fetchone()
        ciphertext = sqldata['ciphertext']
        pg_conn.commit()
    except (psycopg2.InternalError, psycopg2.ProgrammingError) as e:
        pg_conn.rollback()
        bail(error=e.pgerror)

    request = {
            "version": "1.1",
            "method": "receive_message", 
            "params": {
                "ciphertext": ciphertext
                }
            }
    headers = {
            "Content-Type": "application/json"
            }

    request_str = json.dumps(request)
    response = None

    try:
        client.request('POST', messagehub_path, request_str, headers)
        response = client.getresponse()
    except (socket.gaierror, socket.error) as e:
        bail(error="Could not connect to %s: %s" % (messagehub_str, str(e)))

    print " %s %s" % (response.status, response.reason)

    if response.status == 200:
        response_body = response.read()
        response_json = None
        try:
            response_json = json.loads(response_body)

            delivery_reciept = response_json['result']['deliveryreceipt']

            print " Saving delivery recieipt" 

            cur.execute("""SELECT FileID, FromBankID, ToBankID FROM Decode_Delivery_Receipt(
                _DeliveryReceipt := %s
                )""",
                [delivery_reciept])

            sqldata = cur.fetchone()
            print " Message delivered to %s (from %s) %s" % (sqldata['tobankid'], sqldata['frombankid'], sqldata['fileid'])
            pg_conn.commit()
        except KeyError as e:
            if response_json is not None and response_json.get('error'):
                bail(error="Delivery failed with error: %s" % (response_json['error']))
        except ValueError as e:
            bail(error="Failed to process response (%s)" % (response_body))
        except (psycopg2.InternalError, psycopg2.ProgrammingError) as e:
            pg_conn.rollback()
            bail(error=e.pgerror)
    else:
        pass

sys.exit(0)

